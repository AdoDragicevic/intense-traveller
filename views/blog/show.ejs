<%- include("../partials/header") %>

<main>
	<!-- POST -->
	<h2><%= blog.title %></h2>
	<img src="<%= blog.img %>">	
	<p><%= blog.content %></p>
	<p> <em>Posted on <%= blog.created.toDateString() %> </em> </p>
	<p>Posted by <a href="/profile/<%= blog.author.id %>"> <em> <%= blog.author.username %> </em> </a> </p>
	
	<!-- Another button to show the likes, you can remove this one or change it -->
	<div class="float-right">
    	<button type="button" class="btn btn-primary" data-toggle="modal"
            data-target="#blogLikes">
        	<span>Total likes: <i class="fas fa-thumbs-up"></i> <%= blog.likes.length %></span>
    	</button>
	</div>
	
	<!-- Edit & Delete Buttons -->
	<% if(currentUser && blog.author.id.equals(currentUser._id) || currentUser && currentUser.isAdmin){ %>
		<a href="/blog/<%= blog._id %>/edit">Edit</a>
		<form action="/blog/<%= blog._id %>?_method=DELETE" method="POST">
			<button>Delete</button>
		</form>
	<% } %>
	
	
	<a href="/blog">Back</a>
	<hr>
	
	
	<!-- Like button -->
	<div class="pb-5">
    	<form action="/blog/<%= blog._id %>/like" method="POST">
        	<div class="btn-group">
            	<% if (currentUser && blog.likes.some(function (like) {
                	return like.equals(currentUser._id)
            	})) { %>
                	<button class="btn btn-primary">
                    	<i class="fas fa-thumbs-up"></i> Liked (<%= blog.likes.length %>)
                	</button>
            	<% } else { %>
                	<button class="btn btn-secondary">
                    	<i class="fas fa-thumbs-up"></i> Like (<%= blog.likes.length %>)
                	</button>
            	<% } %>
            	<button type="button" class="btn btn-sm btn-default" data-toggle="modal"
                    data-target="#blogLikes">See more details</button>
        	</div>
    	</form>
	</div>
	
	
	<!-- Campground Likes Modal -->
	<div id="blogLikes" class="modal fade" role="dialog">
    	<div class="modal-dialog">
        	<!-- Modal content-->
        	<div class="modal-content">
            	<div class="modal-header">
					<h4 class="modal-title">Likes: <%= blog.likes.length %></h4>
            	</div>
            	<div class="modal-body">
                	<table class="table table-striped">
                    	<thead>
                    		<tr>
                        		<th>Liked by:</th>
                    		</tr>
                    	</thead>
                    	<tbody>
                    		<% blog.likes.forEach(function(like) { %>
                        		<tr>
                            		<td><span class="badge"><i class="fas fa-user"></i></span> <%= like.username %></td>
                        		</tr>
                    		<% }); %>
                    		<% if (blog.likes.length === 0) { %>
                        		<tr>
                            		<td><em>No likes yet.</em></td>
                        		</tr>
                    		<% } %>
                    	</tbody>
                	</table>
            	</div>
            	<div class="modal-footer">
                	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            	</div>
        	</div>
    	</div>
	</div>
	
<!--COMMENT SECTION START-->
<div class="container">
	<div class="card">
		<!--Setting up the add new comment button that is used for collapsing-->
		<div class="float-right">
			<a class="btn btn-success float-right" role="button" data-toggle="collapse" href="#collapseComment" aria-expanded="false" aria-controls="collapseComment">
			<span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Write a Comment</a>
		</div>

		<!--Comment section title-->
		<h4> <strong> Comments <span class="glyphicon glyphicon glyphicon-comment" aria-hidden="true"> </span> </strong> </h4>

		<!--Collapse Add a comment form START-->
		<div class="collapse" id="collapseComment">
			<div class="card" style="border-left: 5px solid #00C851;">
				<% if(!currentUser) { %>
					<!--If the user is not logged in, direct him to the login page-->
					<h5>You need to login before you can comment. <a href="/login">Click here</a> to go to the login page.</h5>
				<% } %>
				<% if(currentUser) { %>
					<!--If the user is logged in, show the new comment form-->
					<h4> Write a Comment <span class="glyphicon glyphicon glyphicon-pencil" aria-hidden="true"> </span> </h4>

					<form id="add-comment-form" action="/blog/<%= blog._id %>/comment" method="POST">
						<div class="form-group">
							<textarea class="form-control" name="comment[text]" placeholder="Write your comment..." form="add-comment-form" rows="5" cols="70"></textarea>
						</div>
						<div class="form-group">
							<button class="btn btn-success btn-sm">Comment <span class="glyphicon glyphicon-comment" aria-hidden="true"></span></button>
						</div>
					</form>
				<% } %>
			</div>
		</div>
		<!--Collapse Add a comment form END-->
		
		<hr>

  		<!--Check if there are comments, if there are none say no comments.-->
    	<% if (blog.comments.length === 0) { %>
  			<em style="color: grey;">No comments yet.</em>
    	<% } %>

  		<!--Display comments by looping through them-->
    	<% blog.comments.forEach(function(comment) { %>
  		<div class="row">
    		<div class="col-md-12">
      			<strong>
          			<% if (currentUser && currentUser._id.equals(comment.author.id)) { %>
        				<!--If the current user owns the comment, change the color of the user icon-->
        				<span style="color: orange;" class="glyphicon glyphicon-user" aria-hidden="true"></span>
          			<% } else { %>
						<!--Else just display it black-->
						<span class="glyphicon glyphicon-user" aria-hidden="true"></span>
          			<% } %>
        			<!--Print out the author username-->
          			<%= comment.author.username %>
      			</strong>

      			<!--Printing the comment-->
      			<p><%= comment.text %></p>

      			<!--If the visitor is logged in and the owner of the comment, show the edit and delete buttons-->
        		<% if (currentUser && currentUser._id.equals(comment.author.id)) { %>
					<!--Edit button used for collapsing the edit comment form-->
      				<a class="btn btn-xs btn-warning" role="button" data-toggle="collapse" href="#collapseEdit<%= comment._id %>" aria-expanded="false" aria-controls="collapse<%= comment._id %>">
        Edit</a>
      				<!--Delete comment button-->
      				<form id="delete-form" action="/campgrounds/<%= blog._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST" style="display: inline;">
        				<button class="btn btn-xs btn-danger">Delete</button>
      				</form>
      				<!--Edit comment form-->
      				<div class="collapse" id="collapseEdit<%= comment._id %>">
        				<div class="card" style="border-left: 5px solid #ffbb33; margin-top: 15px;">
          					<h4>Edit your comment <span class="glyphicon glyphicon-edit" aria-hidden="true"></span></h4>
          					<form id="edit-comment-form<%= comment._id %>" action="/campgrounds/<%= blog._id %>/comments/<%= comment._id %>?_method=PUT" method="POST">
            					<div class="form-group">
              						<input class="form-control" type="text" disabled value="<%= currentUser.username %>">
            					</div>
            					<div class="form-group">
              						<textarea class="form-control" name="comment[text]" placeholder="Your comment text..." form="edit-comment-form<%= comment._id %>" rows="5" cols="70"><%= comment.text %></textarea>
            					</div>
            					<div class="form-group">
              						<button class="btn btn-warning btn-sm">Edit comment <span class="glyphicon glyphicon-comment" aria-hidden="true"></span></button>
            					</div>
          					</form>
        				</div>
      				</div>
        		<% } %>
				<hr>
    		</div>
  		</div>
    <% }) %>
	</div>
	<!--COMMENT SECTION END-->	
</div>	
	
	
	<!-- COMMENTS -->
	<a href="/blog/<%= blog._id %>/comment/new">Write a Comment</a>
	<div>
		<% blog.comments.forEach(function(comment){ %>
			<div>
				<p> <a> <strong> <%= comment.author.username %> </strong> </a>  - <%= comment.text %> </p>
				<% if(currentUser && comment.author.id.equals(currentUser._id) || currentUser && currentUser.isAdmin){ %>
					<a href="/blog/<%= blog._id %>/comment/<%= comment._id %>/edit">Edit</a>
					<form action="/blog/<%= blog._id %>/comment/<%= comment._id %>?_method=DELETE" method="POST">
						<button>Delete</button>
					</form>	
				<% } %>
				<hr>
			</div>
		<% }); %>	
	</div>
	<!-- END OF COMMENTS -->
</main>
	
<%- include("../partials/footer") %>